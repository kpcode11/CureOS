generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String              @id @default(cuid())
  email                       String              @unique
  password                    String
  name                        String
  role                        Role
  roleEntityId                String?
  createdAt                   DateTime            @default(now())
  updatedAt                   DateTime            @updatedAt
  admin                       Admin?
  auditLogs                   AuditLog[]          @relation("AuditLog_actor")
  billingOfficer              BillingOfficer?
  doctor                      Doctor?
  emergencyOverridesRequested EmergencyOverride[] @relation("EmergencyOverride_actor")
  emergencyOverridesTargeted  EmergencyOverride[] @relation("EmergencyOverride_targetUser")
  labTech                     LabTech?
  nurse                       Nurse?
  pharmacist                  Pharmacist?
  receptionist                Receptionist?
  roleEntity                  RoleEntity?         @relation(fields: [roleEntityId], references: [id])
}

model Patient {
  id               String          @id @default(cuid())
  firstName        String
  lastName         String
  email            String?         @unique
  phone            String
  dateOfBirth      DateTime
  gender           String
  address          String?
  emergencyContact String?
  bloodType        String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  appointments     Appointment[]
  bedAssignments   BedAssignment[]
  billings         Billing[]
  emrRecords       EMR[]
  labTests         LabTest[]
  prescriptions    Prescription[]
  referrals        Referral[]
  insurancePolicies InsurancePolicy[]
  insuranceClaims   InsuranceClaim[]
}

model Doctor {
  id                String         @id @default(cuid())
  userId            String         @unique
  specialization    String
  licenseNumber     String         @unique
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  appointments      Appointment[]
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  prescriptions     Prescription[]
  referralsSent     Referral[]     @relation("ReferralsFrom")
  referralsReceived Referral[]     @relation("ReferralsTo")
  surgeries         Surgery[]
}

model Nurse {
  id             String          @id @default(cuid())
  userId         String          @unique
  department     String
  licenseNumber  String          @unique
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  bedAssignments BedAssignment[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  nursingRecords NursingRecord[]
}

model Pharmacist {
  id            String         @id @default(cuid())
  userId        String         @unique
  licenseNumber String         @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  dispensedMeds Prescription[]
}

model LabTech {
  id         String    @id @default(cuid())
  userId     String    @unique
  department String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  labTests   LabTest[]
}

model Receptionist {
  id           String        @id @default(cuid())
  userId       String        @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  appointments Appointment[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Admin {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BillingOfficer {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Appointment {
  id                                           String            @id @default(cuid())
  patientId                                    String
  doctorId                                     String
  receptionistId                               String?
  dateTime                                     DateTime
  reason                                       String
  status                                       AppointmentStatus @default(SCHEDULED)
  notes                                        String?
  createdAt                                    DateTime          @default(now())
  updatedAt                                    DateTime          @updatedAt
  referralId                                   String?           @unique
  doctor                                       Doctor            @relation(fields: [doctorId], references: [id])
  patient                                      Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  receptionist                                 Receptionist?     @relation(fields: [receptionistId], references: [id])
  referral                                     Referral?         @relation(fields: [referralId], references: [id])
  Referral_Referral_appointmentIdToAppointment Referral?         @relation("Referral_appointmentIdToAppointment")
}

model EMR {
  id          String   @id @default(cuid())
  patientId   String
  diagnosis   String
  symptoms    String
  vitals      Json?
  notes       String?
  attachments String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model Prescription {
  id              String      @id @default(cuid())
  patientId       String
  doctorId        String
  pharmacistId    String?
  medications     Json
  instructions    String
  dispensed       Boolean     @default(false)
  dispensedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  pharmacistNotes String?
  transcription   String?
  doctor          Doctor      @relation(fields: [doctorId], references: [id])
  patient         Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  pharmacist      Pharmacist? @relation(fields: [pharmacistId], references: [id])
}

model LabTest {
  id           String        @id @default(cuid())
  patientId    String
  testType     String
  priority     String        @default("ROUTINE")
  results      Json?
  labTechId    String?
  completedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  instructions String?
  orderedAt    DateTime      @default(now())
  status       LabTestStatus @default(PENDING)
  labTech      LabTech?      @relation(fields: [labTechId], references: [id])
  patient      Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model Surgery {
  id               String        @id @default(cuid())
  doctorId         String
  patientName      String
  surgeryType      String
  scheduledAt      DateTime
  status           SurgeryStatus @default(SCHEDULED)
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  anesthesiologist String?
  doctor           Doctor        @relation(fields: [doctorId], references: [id])
}

model Bed {
  id          String          @id @default(cuid())
  bedNumber   String          @unique
  ward        String
  bedType     String
  status      BedStatus       @default(AVAILABLE)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  assignments BedAssignment[]
}

model BedAssignment {
  id           String    @id @default(cuid())
  bedId        String
  patientId    String
  nurseId      String?
  assignedAt   DateTime  @default(now())
  dischargedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  bed          Bed       @relation(fields: [bedId], references: [id])
  nurse        Nurse?    @relation(fields: [nurseId], references: [id])
  patient      Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model NursingRecord {
  id          String   @id @default(cuid())
  nurseId     String
  patientName String
  vitals      Json
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  nurse       Nurse    @relation(fields: [nurseId], references: [id])
}

model Billing {
  id          String        @id @default(cuid())
  patientId   String
  amount      Float
  description String
  status      BillingStatus @default(PENDING)
  dueDate     DateTime
  paidAt      DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  patient     Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model InsurancePolicy {
  id              String              @id @default(cuid())
  patientId       String
  provider        String
  policyNumber    String              @unique
  policyType      String
  coverageAmount  Float
  startDate       DateTime
  endDate         DateTime
  status          InsurancePolicyStatus @default(ACTIVE)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  patient         Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  claims          InsuranceClaim[]
}

model InsuranceClaim {
  id              String              @id @default(cuid())
  policyId        String
  patientId       String
  claimNumber     String              @unique
  claimAmount     Float
  approvedAmount  Float?
  claimDate       DateTime            @default(now())
  status          InsuranceClaimStatus @default(PENDING)
  description     String
  documents       String[]
  notes           String?
  processedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  policy          InsurancePolicy     @relation(fields: [policyId], references: [id])
  patient         Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([policyId])
  @@index([status])
}

model Inventory {
  id            String    @id @default(cuid())
  itemName      String
  category      String
  quantity      Int
  minStock      Int
  unit          String
  lastRestocked DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Emergency {
  id          String            @id @default(cuid())
  patientName String
  condition   String
  severity    EmergencySeverity
  status      EmergencyStatus   @default(ACTIVE)
  arrivedAt   DateTime          @default(now())
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model Incident {
  id          String         @id @default(cuid())
  type        String
  description String
  severity    String
  status      IncidentStatus @default(OPEN)
  reportedAt  DateTime       @default(now())
  resolvedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
}

model RoleEntity {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  isSystemRole    Boolean          @default(false)
  rolePermissions RolePermission[]
  users           User[]
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         RoleEntity @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model EmergencyOverride {
  id           String   @id @default(cuid())
  token        String   @unique
  actorId      String
  reason       String
  targetUserId String?
  expiresAt    DateTime
  used         Boolean  @default(false)
  createdAt    DateTime @default(now())
  actor        User     @relation("EmergencyOverride_actor", fields: [actorId], references: [id], onDelete: Cascade)
  targetUser   User?    @relation("EmergencyOverride_targetUser", fields: [targetUserId], references: [id])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?
  action     String
  resource   String
  resourceId String?
  before     Json?
  after      Json?
  meta       Json?
  ip         String?
  createdAt  DateTime @default(now())
  actor      User?    @relation("AuditLog_actor", fields: [actorId], references: [id])

  @@index([actorId])
}

model Referral {
  id                                              String          @id @default(cuid())
  fromDoctorId                                    String
  toDoctorId                                      String
  patientId                                       String
  reason                                          String
  urgency                                         ReferralUrgency @default(ROUTINE)
  status                                          ReferralStatus  @default(PENDING)
  clinicalNotes                                   String?
  requestedTests                                  String[]
  attachments                                     String[]
  acceptedBy                                      String?
  acceptedAt                                      DateTime?
  rejectedReason                                  String?
  rejectedAt                                      DateTime?
  appointmentId                                   String?         @unique
  expiresAt                                       DateTime?
  metadata                                        Json?
  createdAt                                       DateTime        @default(now())
  updatedAt                                       DateTime        @updatedAt
  appointment                                     Appointment?
  Appointment_Referral_appointmentIdToAppointment Appointment?    @relation("Referral_appointmentIdToAppointment", fields: [appointmentId], references: [id])
  fromDoctor                                      Doctor          @relation("ReferralsFrom", fields: [fromDoctorId], references: [id])
  patient                                         Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  toDoctor                                        Doctor          @relation("ReferralsTo", fields: [toDoctorId], references: [id])

  @@index([fromDoctorId])
  @@index([toDoctorId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
}

enum Role {
  DOCTOR
  NURSE
  PHARMACIST
  LAB_TECH
  RECEPTIONIST
  ADMIN
  BILLING_OFFICER
  EMERGENCY
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum LabTestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum SurgeryStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum BedStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

enum BillingStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum EmergencySeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum EmergencyStatus {
  ACTIVE
  TREATED
  DISCHARGED
  TRANSFERRED
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

enum ReferralStatus {
  PENDING
  ACCEPTED
  REJECTED
  CONVERTED
  EXPIRED
}

enum ReferralUrgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum InsurancePolicyStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum InsuranceClaimStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  PAID
}
